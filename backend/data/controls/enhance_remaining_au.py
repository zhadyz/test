#!/usr/bin/env python3
"""
Enhance remaining 37 AU controls with comprehensive implementation guidance.
"""
import json
from pathlib import Path

# Enhanced guidance for each control
ENHANCEMENTS = {
    "au-2": """Configure comprehensive event logging across all system components. On RHEL 8/9, edit /etc/audit/rules.d/audit.rules to capture security-relevant events: failed login attempts (-w /var/log/faillog -p wa), privilege escalation (sudo/su commands), file access to sensitive directories (-w /etc/shadow -p wa), network connections. Use auditctl to verify rules: `auditctl -l`. For Windows Server, configure Advanced Audit Policy via Group Policy (Computer Configuration → Policies → Windows Settings → Security Settings → Advanced Audit Policy Configuration). Enable specific subcategories: Logon/Logoff, Account Management, Policy Change, Privilege Use, System Events. Forward logs to centralized SIEM (Wazuh, Splunk, ELK Stack) using rsyslog or Windows Event Forwarding. Verify with `ausearch -ts today -i` or Event Viewer. Retention: 90 days minimum per NIST 800-53. Integrates with AU-3 (audit content), AU-12 (audit generation).""",

    "au-3": """Implement the "5 Ws and H" audit framework: What (event type), When (timestamp), Where (location), Who (identity), Why (outcome), How (mechanism). On RHEL 8/9, configure /etc/audit/auditd.conf with log_format=ENRICHED to capture extended attributes including SELinux context, session ID, process ID. Add custom audit rules to /etc/audit/rules.d/ for critical events. Example rule: `-a always,exit -F arch=b64 -S execve -k exec_commands` captures all command executions. For Windows, enable Audit Process Creation with command-line logging (Event ID 4688). Configure syslog to include hostname, facility, severity in RFC5424 format. Use structured logging (JSON) for machine parsing. Verify completeness: `ausearch -k exec_commands -i`. Store logs with tamper-evident controls (AU-9). Correlate with network flow data for complete attack reconstruction. Integrates with AU-2 (events), AU-8 (timestamps), AU-9 (protection).""",

    "au-3.1": """Extend standard audit records with additional organization-specific information: user role/clearance level, data classification labels, application context, geographic location, device identifiers. On RHEL 8/9, use auditd key-value pairs in custom rules: `-a always,exit -F arch=b64 -S open,openat -F dir=/classified -F key=classified_access`. Implement custom audit plugins via audisp to enrich records with LDAP user attributes, asset management tags, threat intelligence context. For Windows, use Custom Views in Event Viewer to correlate Security logs (4624) with Application logs. Deploy osquery or auditbeat to add endpoint telemetry: running processes, network connections, installed software. Store enriched logs in Elasticsearch with custom fields. Example query: `ausearch -k classified_access | aureport -f`. Ensure enrichment doesn't delay real-time alerting (AU-5.2). GDPR compliance: pseudonymize PII in logs (AU-3.3). Integrates with AU-6 (analysis), AU-12 (generation).""",

    "au-3.2": """Centralize audit record content management to ensure consistency across the enterprise. Deploy centralized logging infrastructure using rsyslog, syslog-ng, or Fluent Bit on RHEL 8/9. Configure /etc/rsyslog.conf to forward all auditd logs: `*.* @@logserver.example.com:514` (TCP with TLS encryption). Implement log aggregation server with Elasticsearch/Logstash/Kibana (ELK Stack) or Wazuh manager. Create standardized audit rule templates distributed via Ansible: ansible-playbook -i inventory deploy_audit_rules.yml. Use auditd immutable rules (auditctl -e 2) to prevent tampering. For Windows, configure Group Policy to deploy uniform Advanced Audit Policies across domain. Implement centralized audit record format definitions (JSON schema, CEF, LEEF) stored in version control (Git). Verify consistency: compare auditctl -l output across hosts. Monitor rule drift with configuration management (Puppet, Chef, SaltStack). Integrates with AU-2 (event selection), AU-4 (storage), AU-6 (analysis).""",

    "au-3.3": """Limit personally identifiable information (PII) in audit records to minimize privacy risks while maintaining security visibility. Implement data masking/redaction in audit pipelines. On RHEL 8/9, use auditd exclude filters to skip capturing full command lines for sensitive commands: `-a exclude,always -F msgtype=EXECVE -F exe=/usr/bin/passwd`. Configure rsyslog to redact PII using regex before forwarding: `$ModLoad omprog` with custom Python script. For application logs, use structured logging libraries (Python: structlog, Java: logback) with automatic PII redaction for fields like SSN, credit card numbers. Deploy Logstash with grok filters to redact PII: `mutate { gsub => ["message", "\\b\\d{3}-\\d{2}-\\d{4}\\b", "XXX-XX-XXXX"] }`. Implement role-based access to raw vs. redacted logs (AU-9.4). Document PII handling in privacy impact assessment. For GDPR: implement right-to-erasure for user-specific logs. Verify with test data: inject known PII, confirm redaction. Integrates with AU-3.1 (additional content), AU-9 (protection).""",

    "au-5.3": """Configure audit system to detect and alert on configurable traffic volume thresholds to identify denial-of-service or data exfiltration. On RHEL 8/9, use auditd num_logs and max_log_file_action settings in /etc/audit/auditd.conf to control log rotation at volume thresholds. Deploy rate limiting with rsyslog: `$SystemLogRateLimitInterval 10` and `$SystemLogRateLimitBurst 500`. Implement SIEM correlation rules (Wazuh, Splunk) to detect log volume anomalies: >10,000 events/minute from single source. Use Prometheus + Grafana to monitor audit log ingestion rates with alerts. Create custom auditd plugin to track events/second: check /var/run/auditd.state. For network traffic correlation, deploy flow monitoring (NetFlow, sFlow) alongside audit logs. Configure alerts for sudden log volume drops (potential audit evasion). Example threshold: normal=1000 events/min, warning=5000, critical=10000. Tune thresholds based on baseline analysis (2-week rolling average). Integrates with AU-5 (response to failures), AU-6(2) (automated alerts).""",

    "au-5.4": """Implement audit system shutdown on critical failures to prevent operation in insecure state. On RHEL 8/9, configure /etc/audit/auditd.conf with `admin_space_left_action = halt` or `disk_error_action = halt`. This triggers system shutdown when audit storage <50MB or disk errors occur. For less critical failures, use `admin_space_left_action = single` to drop to single-user mode. Configure kernel panic on audit failure: `auditctl -e 2` sets immutable mode where audit failures cause panic. On Windows Server, configure Event Log to shutdown via Group Policy when Security log reaches maximum size and cannot overwrite. Deploy hardware watchdog timer to force reboot if system hangs during shutdown. Document recovery procedures: boot from rescue media, expand audit partition, resume operations. Test shutdown behavior in dev environment: `dd if=/dev/zero of=/var/log/audit/test bs=1M` to fill partition. Balance security (halt on failure) vs. availability (continue with alerts). Integrates with AU-5 (failure response), AU-4.1 (transfer to alternate storage).""",

    "au-5.5": """Provide alternate audit logging capability for use when primary fails. On RHEL 8/9, configure dual audit paths: primary to /var/log/audit/, secondary to network syslog server. Edit /etc/rsyslog.conf: `*.* @@backup-syslog.example.com:514`. Deploy audisp (audit dispatcher) to simultaneously write to local disk and remote host: configure /etc/audit/plugins.d/syslog.conf with `active = yes`. For hardware redundancy, use RAID-1 for /var/log partition. Implement failover to secondary SIEM cluster (Wazuh standby node, ELK Stack hot-standby). On Windows, configure dual Event Log Forwarding targets via Group Policy. Deploy local audit buffer with auditd `q_depth = 10240` to queue records during network outages. Use Fluent Bit with persistent buffer: `[INPUT] Name systemd Tag audit` and `[OUTPUT] storage.type filesystem`. Verify failover: disconnect network, confirm local buffering continues. Test recovery: restore connectivity, verify log replay. Integrates with AU-4 (capacity), AU-9.2 (backup on separate systems).""",

    "au-6(5)": """Integrate audit record analysis with vulnerability scanning, SIEM correlation, and threat intelligence feeds. Deploy Wazuh for automated analysis: correlates audit logs with CVE databases, MITRE ATT&CK framework, and custom threat indicators. Configure /var/ossec/etc/ossec.conf with multiple decoders: audit, syslog, firewall logs. Use Elasticsearch aggregations to correlate audit events with vulnerability scan results from OpenVAS, Nessus, or Qualys. Example: match failed login attempts (audit event) with known exploitable services (vuln scan). Implement SOAR platform (Cortex, Phantom) to automate response workflows. Create Logstash pipeline to enrich audit logs with threat intel from MISP, AlienVault OTX, Talos Intelligence. Use machine learning (Elastic SIEM ML jobs) to detect anomalies combining audit data with network flow, endpoint telemetry. Query example: `aureport -au | grep -f known_compromised_accounts.txt`. Integrates with AU-6(1) (automated processes), AU-6(3) (correlate repositories), RA-5 (vulnerability scanning).""",

    "au-6(8)": """Perform full text analysis of audit records including keyword searches, pattern matching, and natural language processing. Deploy Elasticsearch with audit log indexing for full-text search capabilities. On RHEL 8/9, configure Filebeat to ship audit logs: edit /etc/filebeat/filebeat.yml with input type auditd. Create Kibana dashboards with search queries: `event.action:executed AND process.name:bash`. Use Lucene query syntax for complex searches: `user.name:admin AND NOT event.outcome:success`. Implement regular expression searches in Splunk: `index=audit | regex _raw="FAILED.*SSH"`. Deploy log analysis tools: grep, awk for quick CLI searches: `ausearch -ts today | grep -E 'SYSCALL.*execve.*passwd'`. Use natural language processing (NLP) with Python nltk or spaCy to extract entities from unstructured log messages. Create saved searches for common investigation patterns: privilege escalation, lateral movement, data exfiltration. Implement case-insensitive searches with normalization. Verify indexing: `curl -X GET "localhost:9200/auditbeat-*/_search?q=user:root"`. Integrates with AU-6(1) (automated processes), AU-7 (audit reduction).""",

    "au-8.2": """Implement secondary authoritative time source for backup when primary fails. On RHEL 8/9, configure chrony with multiple NTP servers in /etc/chrony.conf: `server 0.rhel.pool.ntp.org iburst`, `server 1.rhel.pool.ntp.org iburst`, `server tick.usno.navy.mil iburst` (USNO provides authoritative US time). Set pool directive for automatic failover: `pool pool.ntp.org iburst maxsources 4`. For air-gapped systems, deploy local NTP server synchronized to GPS receiver or atomic clock. On Windows Server, configure multiple time sources via Group Policy: Computer Configuration → Policies → Administrative Templates → System → Windows Time Service → Time Providers. Use timedatectl to verify synchronization: `timedatectl status | grep 'synchronized: yes'`. Monitor time drift with Prometheus node_exporter: `node_time_seconds - node_ntp_offset_seconds`. Implement alerts for sync loss: `chronyc sources` shows no reachable sources. Test failover: block primary NTP, verify switch to secondary within 5 minutes. Integrates with AU-8 (timestamps), AU-8.1 (synchronization).""",

    "au-9.1": """Store audit records on hardware write-once media (WORM) to ensure immutability. Deploy WORM-compliant storage: tape libraries (LTO-9 with WORM cartridges), optical media (BD-R XL), or WORM-enabled disk arrays (NetApp SnapLock, Dell EMC Compliance Edition). On RHEL 8/9, use rsyslog to forward audit logs to WORM storage: configure /etc/rsyslog.conf with output module: `$ActionQueueType LinkedList` and `$ActionResumeInterval 30` for reliable delivery. For cloud environments, use S3 Object Lock (AWS) or Immutable Blob Storage (Azure) with compliance mode preventing deletion. Implement write-once file systems: configure ext4 with immutable attribute: `chattr +i /var/log/audit/archive/*.log`. Use hardware controllers that prevent overwrites (IBM LTO WORM mode). Verify immutability: attempt to modify archived logs, confirm denial. Maintain chain of custody documentation for legal admissibility. Retention: 1 year for most data, 3-7 years for financial/healthcare per regulations. Integrates with AU-9 (protection), AU-11 (retention), AU-10.3 (chain of custody).""",

    "au-9.2": """Implement near real-time audit record backup to separate physical systems for redundancy and survivability. On RHEL 8/9, configure rsyslog remote forwarding with TCP/TLS: edit /etc/rsyslog.conf with `*.* @@(o)backup-server.example.com:6514`. Deploy Filebeat with multiple outputs to geographically separated Elasticsearch clusters. Use audisp-remote plugin: configure /etc/audit/plugins.d/au-remote.conf with `remote_server = backup.example.com`, `enable_krb5 = yes` for authenticated forwarding. For Windows, configure Windows Event Forwarding (WEF) to collector servers in different datacenter. Implement network segregation: backup system on separate VLAN, firewall rules allow only audit traffic. Use message queuing (RabbitMQ, Apache Kafka) for reliable delivery with persistence. Configure backup retention independent of primary: primary 90 days, backup 1 year. Verify continuous replication: `tail -f /var/log/audit/audit.log | nc backup-server 514`. Test recovery: simulate primary system loss, demonstrate log reconstruction from backup. Integrates with AU-4.1 (alternate storage), AU-9 (protection), AU-11 (retention).""",

    "au-9.3": """Implement cryptographic protection for audit information to ensure integrity and detect tampering. On RHEL 8/9, configure auditd with crypto_disk=yes in /etc/audit/auditd.conf to enable disk encryption for audit logs. Use LUKS encryption for /var/log/audit partition: `cryptsetup luksFormat /dev/sdb1`, mount with /etc/crypttab. Deploy GPG signing for audit records: create audit signing key (`gpg --gen-key`), configure audisp plugin to sign rotated logs. Use OpenSSL for hash verification: `openssl dgst -sha256 audit.log > audit.log.sha256`. Implement HMAC-based authentication codes with shared secret. For Windows Event Logs, use Encrypting File System (EFS) for archive storage. Deploy file integrity monitoring (AIDE, Tripwire) to detect unauthorized changes: `aide --init`, `aide --check`. Use blockchain-based audit trails for immutable ledger (Hyperledger Fabric). Verify integrity: `gpg --verify audit.log.sig audit.log` or `sha256sum -c audit.log.sha256`. Store cryptographic keys in HSM or TPM. Document key rotation procedures. Integrates with AU-9 (protection), AU-10.5 (digital signatures), SC-13 (cryptographic protection).""",

    "au-9.4": """Restrict access to audit records to subset of privileged users with legitimate need. On RHEL 8/9, configure /var/log/audit permissions: `chmod 0600 audit.log`, `chown root:root audit.log`. Create dedicated audit admin group: `groupadd auditadmin`, add authorized users: `usermod -aG auditadmin alice`. Use SELinux policies to enforce access: `semanage fcontext -a -t auditd_log_t "/var/log/audit(/.*)?"`. Configure auditd to log access attempts to audit logs: `-w /var/log/audit/ -p r -k audit_access`. For Elasticsearch/Kibana, implement role-based access control (RBAC): create read-only role for audit indices, assign to security analysts. Use Wazuh agent.conf to restrict API access with authentication tokens. On Windows, set ACLs on Event Log files: `wevtutil sl Security /ca:O:BAG:SYD:(A;;0x1;;;S-1-5-32-544)`. Implement multi-factor authentication for audit system access. Audit the auditors: log all access to audit infrastructure (AU-6). Review access quarterly: `ausearch -k audit_access -i`. Integrates with AU-9 (protection), AC-6 (least privilege), AC-3 (access enforcement).""",

    "au-9.5": """Enforce dual authorization for movement or deletion of audit information to prevent single-person abuse. Implement cryptographic split-key systems: require two separate GPG keys to decrypt archived audit logs. On RHEL 8/9, create custom sudo rules requiring two approvers for audit operations: configure /etc/sudoers.d/audit_dual_auth with pam_exec module calling approval script. Deploy workflow systems (ServiceNow, Jira) for audit deletion requests requiring manager + security officer approval with documented justification. For cloud storage (S3, Azure Blob), enable MFA delete requiring two authentication factors. Use Hashicorp Vault with Shamir secret sharing: split audit encryption key into 5 shares, require 3 to reconstruct. Implement four-eyes principle for audit log exports: log access attempts, require secondary verification within 4 hours. Create approval chains in SIEM: Wazuh active response requiring second admin to acknowledge before executing deletion. Audit dual auth events: `-w /var/log/audit/ -p d -k audit_delete`. Test procedure annually: attempt single-person deletion, verify block. Integrates with AU-9 (protection), AC-3 (access enforcement), AC-5 (separation of duties).""",

    "au-9.6": """Authorize read-only access to audit records for designated personnel to prevent tampering while enabling analysis. On RHEL 8/9, create read-only audit view using mount bind with noexec,ro flags: `mount --bind -o ro,noexec /var/log/audit /mnt/audit_readonly`. Configure AppArmor/SELinux profiles enforcing read-only for security analyst accounts. Deploy Elasticsearch with read-only index patterns: create Kibana space with viewer role, restrict write operations via API. Use PostgreSQL views for audit database: `CREATE VIEW audit_readonly AS SELECT * FROM audit_log` with revoked UPDATE/DELETE privileges. On Windows, configure Event Log read-only subscriptions via Group Policy. Implement write-blocking hardware for forensic analysis: USB write blockers for audit log exports. Create read-only Samba shares: `[audit_logs] path=/var/log/audit read only=yes`. Use version control for audit rule changes: store in Git, read-only clone for analysts. Audit read access: `-w /var/log/audit/ -p r -k audit_read`. Monitor for privilege escalation attempts. Quarterly access reviews: validate read-only permissions persist. Integrates with AU-9 (protection), AU-6 (review/analysis), AC-3 (access enforcement).""",

    "au-9.7": """Store audit records on system component with different operating system to prevent OS-specific compromise from affecting audit integrity. Deploy dedicated audit logging appliance running hardened OS: Wazuh manager on Ubuntu Server 22.04 LTS (minimal installation) collecting from RHEL 8/9 endpoints. Use FreeBSD-based syslog server receiving logs from Linux/Windows production systems. Deploy commercial SIEM appliances (Splunk, LogRhythm) with proprietary OS distinct from monitored systems. For cloud environments, use managed logging services (AWS CloudWatch, Azure Monitor, GCP Cloud Logging) running on provider infrastructure separate from EC2/VMs. Configure rsyslog forwarding from RHEL to Windows Event Collector: `*.* @@windows-collector:515`. Use network-attached storage (NAS) appliances with embedded OS for audit archives. Implement air-gapped log collection: segregated network segment with unidirectional data diode. Ensure diversity across entire audit chain: endpoint OS ≠ collector OS ≠ storage OS ≠ analysis OS. Test cross-OS compatibility: verify log format preservation through pipeline. Integrates with AU-4.1 (alternate storage), AU-9.2 (separate systems), SC-29 (heterogeneity).""",

    "au-10.1": """Associate audit records with identities of individuals, processes, or devices that generated events to establish non-repudiation. On RHEL 8/9, configure auditd to capture UID, AUID (audit UID), EUID in all audit records: auditd automatically includes these in SYSCALL records. Enhance with session tracking: `-w /var/run/utmp -p wa -k session` and `-w /var/log/wtmp -p wa -k session`. Integrate with PKI: correlate audit events with X.509 certificate serial numbers for authenticated users. For service accounts, implement identity federation with OpenID Connect claims in audit logs. On Windows, enable Advanced Audit Policy for Account Logon Events to capture SID, username, domain. Deploy osquery to correlate process PIDs with parent processes and user contexts: `SELECT * FROM processes JOIN users USING (uid)`. Use auditd's ENRICHED log format to include comm (command name), exe (executable path), key (audit rule key). Implement source IP/MAC address logging for network-based authentication. Verify identity association: `ausearch -ua alice -i` shows all events by user alice. Integrates with IA-2 (identification/authentication), AU-3 (audit content), AU-10 (non-repudiation).""",

    "au-10.2": """Validate binding between information producer identity and audit record to prevent spoofing. Implement cryptographic binding using digital signatures: configure auditd to sign records with private key, verify with public key. On RHEL 8/9, use audit-sign plugin: generate RSA key pair (`openssl genrsa -out audit_key.pem 4096`), configure /etc/audit/plugins.d/audit-sign.conf. Deploy IPsec or TLS mutual authentication for remote log forwarding: rsyslog with x509/name matching to verify sender identity. Use Kerberos authentication for audit trail: configure audisp-remote with `enable_krb5 = yes`, verify principal matches expected source. Implement message authentication codes (MAC) with HMAC-SHA256: shared secret between producer and collector. For application audit trails, use JSON Web Tokens (JWT) with signature verification. On Windows, enable EventLog channel encryption with certificate-based authentication. Deploy tamper-evident logging with Merkle trees: hash chaining where each record includes hash of previous record. Verify binding: `openssl dgst -sha256 -verify audit_pubkey.pem -signature audit.log.sig audit.log`. Test spoofing resistance: attempt to inject forged audit record, verify rejection. Integrates with AU-10.1 (identity association), AU-10.5 (digital signatures), SC-8 (transmission confidentiality/integrity).""",

    "au-10.3": """Maintain reviewer-verifiable chain of custody for audit information from generation through analysis and disposal. Implement comprehensive custody documentation: timestamp, custodian name, action taken, hash of audit data. On RHEL 8/9, create custody log for audit transfers: `echo "$(date -Iseconds),$(whoami),exported,$(sha256sum audit.log)" >> custody_log.txt`. Use write-once storage (AU-9.1) to preserve original state. Deploy blockchain-based audit trails: Hyperledger Fabric with chaincode recording custody events immutably. For legal/forensic scenarios, use forensic tools (EnCase, FTK) with built-in chain of custody features. Create digital evidence bags: tar + GPG signature preserving metadata and custody info: `tar czf evidence.tar.gz audit/ && gpg --sign evidence.tar.gz`. Implement access logging for custody chain: `-w /mnt/audit_archive/ -p rwa -k custody_access`. Use barcode/RFID tracking for physical media (tapes, optical discs). Document procedures in incident response plan: who can access, under what authority, review requirements. Maintain custody forms: date/time, from whom, to whom, purpose, hash verification. Verify chain integrity: validate all hash values match from generation to current state. Integrates with AU-9 (protection), AU-10.1 (identity), AU-11 (retention).""",

    "au-10.4": """Validate binding of information reviewer identity to audit analysis results to establish accountability. Implement code signing for audit reports: analysts sign findings with GPG key. On RHEL 8/9, create report signature workflow: `gpg --clearsign audit_analysis_report.txt`. Deploy audit analysis platform (Wazuh, Splunk) with user authentication and action logging: track who ran which queries, when, and what they viewed. Use Git for audit investigation notes: commit messages signed with `git commit -S`, verify with `git log --show-signature`. Implement SIEM dashboard access controls: log which analyst viewed which dashboard, time range queried. Create audit of audit analysis: `-a always,exit -F path=/usr/bin/ausearch -F perm=x -k audit_analysis`. For formal investigations, use digital signature on final reports: openssl smime -sign -in report.txt -out report.signed. Deploy Jupyter notebooks with kernel authentication for reproducible audit analysis. Maintain evidence documentation: analyst name, timestamp, search criteria, results hash. On Windows, use PowerShell transcript logging for audit analysis sessions: `Start-Transcript`. Verify reviewer binding: `gpg --verify report.signed` confirms analyst identity. Quarterly review: audit who analyzed what, validate against authorized personnel list. Integrates with AU-6 (review/analysis), AU-10.1 (identity association), AU-12 (audit generation).""",

    "au-10.5": """Protect audit records with digital signatures to ensure non-repudiation and detect tampering. On RHEL 8/9, configure auditd GPG signing: install gnupg2 (`dnf install gnupg2`), generate 4096-bit RSA signing key (`gpg --gen-key`), configure /etc/audit/auditd.conf with `crypto_disk = yes`. Create audit log signing script triggered on rotation: `#!/bin/bash\nLOGFILE=$1\ngpg --detach-sign --armor $LOGFILE`. Use OpenSSL for hash-based signatures: `openssl dgst -sha512 -sign audit_privkey.pem -out audit.log.sig audit.log`. Deploy Hardware Security Module (HSM) or TPM 2.0 for private key storage preventing extraction. For Windows Event Logs, enable digital signatures via Group Policy: Computer Configuration → Policies → Windows Settings → Security Settings → Event Log → Digitally sign events. Implement timestamping authority (TSA) for signature timestamps proving when signing occurred. Use X.509 certificates from organizational PKI for signing keys. Create signature verification cron job: `0 * * * * find /var/log/audit/archive -name "*.sig" -exec gpg --verify {} \;`. Document key management: generation, storage, rotation (annual), revocation procedures. Test signature: `gpg --verify audit.log.asc audit.log` returns "Good signature". Integrates with AU-9.3 (cryptographic protection), AU-10.2 (validate binding), SC-13 (cryptographic protection).""",

    "au-11": """Retain audit records for minimum 1 year with long-term retention (3-7 years) for compliance. On RHEL 8/9, configure /etc/audit/auditd.conf with `max_log_file = 100` (MB), `num_logs = 365` (daily rotation for 1 year), `max_log_file_action = rotate`. Implement archive pipeline: cron job to compress and move logs older than 90 days to long-term storage: `find /var/log/audit -name "audit.log.*" -mtime +90 -exec gzip {} \; -exec mv {}.gz /mnt/audit_archive/ \;`. Deploy tape libraries (LTO-9) for multi-year retention with barcode tracking. Use cloud archival tiers: AWS S3 Glacier Deep Archive with retrieval SLA 12 hours. Configure retention policies aligned with regulations: HIPAA 6 years, SOX 7 years, GDPR variable based on data processing purpose. Implement automated retention enforcement: delete logs older than policy requires. Create retention schedule documentation: what gets retained, how long, where stored, who can access. Use immutable storage (AU-9.1) for archived logs. On Windows, configure Event Log size limits and archival: Event Viewer → Properties → Maximum log size, Archive when full. Verify retention: `find /var/log/audit -type f | wc -l` matches expected count. Integrates with AU-4 (capacity), AU-9 (protection), AU-11.1 (long-term retrieval).""",

    "au-11.1": """Employ long-term retrieval capability for archived audit records spanning years or decades. Deploy enterprise content management (ECM) systems: OpenText, SharePoint with metadata indexing for rapid search across terabyte-scale archives. On RHEL 8/9, create searchable index of archived logs using Elasticsearch with audit-specific index lifecycle management (ILM): hot (30 days), warm (90 days), cold (1 year), frozen (7 years). Implement tape library management software (Bacula, Amanda) with barcode tracking and robotic retrieval. Use data warehousing with SQL indexing: import audit logs to PostgreSQL with indexes on timestamp, user, event_type for sub-second retrieval. Deploy Splunk with summary indexing for long-term data: create scheduled searches generating summary events reducing storage while maintaining searchability. Maintain file system hierarchy: `/mnt/audit_archive/YYYY/MM/DD/audit.log.gz` enabling date-based retrieval. Document retrieval procedures: estimated time for tape recall, cloud Glacier restore, compressed file extraction. Use compression with indexing: gzip with .gzi index files for random access. Create metadata database: file path, date range, hash, storage location enabling search without full decompression. Test quarterly: retrieve random archived log from 3+ years ago, verify integrity and completeness. Integrates with AU-11 (retention), AU-9.1 (WORM media), AU-6 (review/analysis).""",

    "au-12(1)": """Compile system-wide time-correlated audit trail from individual component logs. Deploy centralized SIEM (Wazuh, Splunk, ELK Stack) ingesting logs from all endpoints, network devices, applications, databases. On RHEL 8/9, configure rsyslog to tag logs with hostname and forward to correlation engine: `$template CustomFormat,"%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n"` in /etc/rsyslog.conf. Implement NTP synchronization (AU-8.1) ensuring all systems within 1 second of UTC. Use Logstash to normalize timestamps to ISO 8601 format regardless of source. Create correlation rules in Wazuh: detect multi-stage attacks spanning firewall (block), IDS (alert), endpoint (lateral movement). Deploy Stream processing (Apache Kafka + ksqlDB) for real-time correlation across distributed sources. Use Elasticsearch aggregations to reconstruct timelines: `GET /logs-*/_search { "aggs": { "by_user": { "terms": { "field": "user.name" }, "aggs": { "timeline": { "date_histogram": { "field": "@timestamp", "interval": "1m" } } } } } }`. Implement session tracking correlating authentication (UNIX utmp), process execution (auditd EXECVE), network connections (firewall logs). Create unified schema (Elastic Common Schema, OCSF) for cross-system correlation. Verify correlation: trace single user session across login, command execution, file access, network activity. Integrates with AU-8 (timestamps), AU-6(3) (correlate repositories), AU-12 (audit generation).""",

    "au-12(2)": """Provide standardized audit record formats across diverse systems for machine parsing. Adopt Common Event Format (CEF), Log Event Extended Format (LEEF), or Elastic Common Schema (ECS). On RHEL 8/9, configure rsyslog output template for RFC5424 structured data: `template(name="RFC5424" type="string" string="<%PRI%>1 %TIMESTAMP:::date-rfc3339% %HOSTNAME% %APP-NAME% %PROCID% %MSGID% [audit_info user=\"%usr%\" action=\"%action%\"] %msg%\n")`. Deploy Filebeat with ECS formatting: edit /etc/filebeat/filebeat.yml with `fields_under_root: true` and custom field mappings. Use Logstash to transform logs into JSON schema: `filter { json { source => "message" } mutate { rename => { "[host][name]" => "hostname" } } }`. Implement STIX/TAXII for threat intelligence sharing with standardized indicators. Create organization-wide field naming convention: user.name, event.action, event.outcome, source.ip, destination.ip. Use OpenTelemetry for distributed tracing with standardized span format. Deploy log validation: JSON Schema or XML Schema checking all logs conform to standard. On Windows, export Event Logs to JSON or XML: `wevtutil qe Security /f:RenderedXml`. Create data dictionary documenting all field names, types, and allowed values. Test parsing: ingest sample logs into SIEM, verify automatic field extraction without custom parsers. Integrates with AU-6 (analysis), AU-12(1) (system-wide trail), SI-4 (information system monitoring).""",

    "au-12(3)": """Require audit trails to identify changes made by authorized individuals and processes. On RHEL 8/9, configure auditd to capture all file modifications by privileged users: `-a always,exit -F arch=b64 -S chmod,chown,setxattr,removexattr -F auid>=1000 -F auid!=unset -k perm_mod`. Track sudo usage: `-a always,exit -F arch=b64 -S execve -F euid=0 -F auid>=1000 -F auid!=unset -k privileged_commands`. Log database changes: enable PostgreSQL audit extension (pgaudit) logging DDL/DML with username, timestamp, affected tables. For application changes, implement change data capture (CDC) with Apache Kafka tracking all CRUD operations. Configure Git hooks for infrastructure-as-code: pre-commit hook logging who changed which Terraform/Ansible files. Deploy configuration management auditing: Puppet/Ansible logging all configuration drift corrections. Use auditd watch on critical files: `-w /etc/shadow -p wa -k identity_changes`, `-w /etc/sudoers -p wa -k sudoers_changes`. For Windows, enable Object Access auditing with SACL on critical files/registry keys. Create change approval workflow: ServiceNow change requests correlated with audit logs validating authorized changes occurred. Analyze changes: `ausearch -k perm_mod -i | aureport --file --summary`. Quarterly review: compare authorized change tickets vs. audit log changes, investigate discrepancies. Integrates with CM-3 (configuration change control), AC-6 (least privilege), AU-2 (event logging).""",

    "au-12(4)": """Audit query parameters and database operations to detect SQL injection and data exfiltration. Enable database audit logging for all major DBMS platforms. PostgreSQL: install pgaudit extension (`CREATE EXTENSION pgaudit;`), configure postgresql.conf with `pgaudit.log = 'read, write, ddl, role'`. MySQL: enable audit plugin (`INSTALL PLUGIN audit_log SONAME 'audit_log.so';`), configure audit_log_policy=ALL. Microsoft SQL Server: enable SQL Server Audit via SSMS, create Database Audit Specification logging SELECT/INSERT/UPDATE/DELETE. Oracle: enable Unified Auditing with `AUDIT SELECT TABLE BY ACCESS`. MongoDB: enable auditLog in mongod.conf: `auditLog: {destination: file, path: /var/log/mongodb/audit.json}`. Log full query text including parameters: detect suspicious patterns (UNION SELECT, OR 1=1, xp_cmdshell). On RHEL 8/9, use auditd to monitor database file access: `-w /var/lib/pgsql/data -p rwa -k database_access`. Deploy database activity monitoring (DAM) tools: IBM Guardium, Imperva SecureSphere. Create SIEM correlation rules detecting anomalies: queries returning >10000 rows, queries from unusual source IPs, privilege escalation attempts. Alert on query parameter manipulation: bind variable changes, unusual LIKE clauses. Verify: `psql -c "SELECT * FROM pg_stat_statements WHERE query LIKE '%password%';"`. Integrates with SI-4 (monitoring), AU-2 (event logging), SC-7 (boundary protection).""",

    "au-13.1": """Use automated tools for monitoring audit data to reduce analyst workload and improve detection speed. Deploy SIEM platforms with machine learning: Splunk Enterprise Security with ML Toolkit, Elastic SIEM with anomaly detection jobs, Wazuh with integrated anomaly detection. On RHEL 8/9, configure Wazuh agent to analyze local audit logs: edit /var/ossec/etc/ossec.conf enabling `<localfile><log_format>audit</log_format></localfile>`. Create automated correlation rules: detect brute-force (>5 failed logins in 1 minute), privilege escalation (sudo to root from non-admin user), data exfiltration (large outbound transfers). Use osquery scheduled queries for automated compliance checks: `SELECT * FROM users WHERE uid=0 AND username!='root';` detecting unauthorized root accounts. Deploy log analysis tools: Logwatch (daily summary emails), fail2ban (automated IP blocking), OSSEC active response. Implement anomaly detection with statistical baselines: detect logins from new countries, processes using excessive CPU, unusual command sequences. Use Python scripts with pandas/scikit-learn for custom analysis: time series analysis of login patterns, clustering of user behaviors. Configure automated reporting: weekly audit summary with key metrics (failed logins, privilege escalations, policy violations). Create dashboards in Grafana/Kibana with real-time visualizations. Reduce false positives through continuous tuning. Verify automation: inject test event, confirm automated alert within 5 minutes. Integrates with AU-6 (review/analysis), AU-6(1) (automated processes), IR-4 (incident handling).""",

    "au-13.3": """Block unauthorized replication of audit information to prevent data leakage. Implement data loss prevention (DLP) controls on audit systems. On RHEL 8/9, use SELinux to prevent unauthorized copying: create custom policy restricting /var/log/audit/ access to auditd process only. Configure file system permissions: `chmod 0600 /var/log/audit/audit.log`, use ACLs: `setfacl -m u:alice:--- /var/log/audit/`. Deploy USB device blocking: udev rules preventing unauthorized USB storage: create /etc/udev/rules.d/10-usb-deny.rules with `ACTION=="add", SUBSYSTEMS=="usb", RUN+="/bin/sh -c 'echo 0 >/sys$DEVPATH/authorized'"`. Implement network DLP: configure firewall rules blocking rsyslog/syslog traffic except to authorized destinations. Use AppArmor profiles restricting process capabilities: prevent wget, curl, scp from accessing audit directories. For Elasticsearch, configure index access controls: read-only for analysts, no reindex/snapshot permissions. Deploy file integrity monitoring (AIDE) alerting on unauthorized audit log copies: `aide --check | grep "/var/log/audit"`. On Windows, use BitLocker with TPM preventing offline disk access, configure NTFS permissions denying non-admin reads. Create audit trail of access attempts: `-w /var/log/audit/ -p r -k unauthorized_audit_access`. Implement exfiltration detection: monitor for large data transfers from audit servers. Test controls: attempt to copy audit.log as non-privileged user, verify denial. Integrates with AU-9 (protection), AC-3 (access enforcement), SC-7 (boundary protection).""",

    "au-14": """Implement session auditing to capture all user activities within interactive sessions. On RHEL 8/9, deploy screen recording using script command automatically on SSH login: add to /etc/profile: `if [ -n "$SSH_CONNECTION" ]; then script -qf /var/log/sessions/$(date +%Y%m%d_%H%M%S)_$USER.log; fi`. Configure sudosh2 for shell session recording: install and configure as default shell for privileged users. For privileged access management, deploy BeyondTrust, CyberArk Session Bridge capturing full RDP/SSH sessions with video replay. Use asciinema for terminal session recording with web-based playback: `asciinema rec /var/log/sessions/session.cast`. On Windows, enable PowerShell transcript logging: Group Policy → Administrative Templates → Windows PowerShell → Turn on PowerShell Transcription, output to `\\server\share\PSTranscripts`. Configure RDP session logging: enable Remote Desktop Session Host auditing capturing all actions. Deploy database session recording: Oracle Database Vault session capture, PostgreSQL log_statement=all with session correlation. Implement kernel-level session monitoring: auditd TTY auditing capturing all keystrokes: `-a always,exit -F arch=b64 -S write -F a0=1 -k tty_input`. Create automated analysis detecting suspicious session activities: unusual commands, off-hours access, rapid command sequences. Retain session logs per AU-11 retention policy. Verify: cat /var/log/sessions/*.log shows full command history. Integrates with AC-2 (account management), AU-3 (audit content), IA-4 (identifier management).""",

    "au-14.1": """Initiate session auditing automatically at system start-up to capture all activities from boot. On RHEL 8/9, configure systemd to start session auditing early in boot sequence: create /etc/systemd/system/session-audit.service with `Before=multi-user.target`, `WantedBy=multi-user.target`. Enable auditd early boot logging: configure kernel command line in /etc/default/grub with `audit=1` parameter, regenerate grub config: `grub2-mkconfig -o /boot/grub2/grub.cfg`. This enables audit logging before auditd daemon starts. Configure rsyslog to start before user sessions: verify rsyslog.service has `Before=getty.target`. Implement systemd-journald persistent storage: create /var/log/journal/ directory, configure /etc/systemd/journald.conf with `Storage=persistent` capturing boot messages. For UEFI Secure Boot systems, enable UEFI event logging to TPM capturing firmware-level events. On Windows, configure Event Log service to auto-start: verify Windows Event Log service startup type is Automatic in services.msc. Enable Early Launch Antimalware (ELAM) logging capturing pre-boot drivers. Deploy measured boot with TPM logging all boot components. Configure BIOS/UEFI audit logging where available (Dell iDRAC, HP iLO). Create boot event analysis: `journalctl -b | grep audit` or `ausearch -m SYSTEM_BOOT -i`. Verify session auditing active before first user login: check timestamps in audit.log vs. system boot time. Integrates with AU-14 (session audit), SI-7 (integrity verification), SC-8 (transmission confidentiality/integrity).""",

    "au-14.2": """Capture and record content within sessions including screen output, keystrokes, mouse clicks, and accessed resources. Deploy comprehensive session recording solutions: Teleport for SSH/Kubernetes session recording with video playback, Apache Guacamole for RDP/VNC recording. On RHEL 8/9, implement screen recording with ttyrec: `ttyrec /var/log/sessions/session-$(date +%s).ttyrec`, playback with ttyplay. Configure X11 session recording using recordmydesktop or VNC server logging: `recordmydesktop --output=/var/log/sessions/x11-session.ogv`. For terminal sessions, use asciinema with automatic recording: add to ~/.bashrc: `asciinema rec --append /var/log/sessions/$(whoami).cast`. Deploy keylogger for privileged sessions (with user notice): configure kernel-level keystroke capture via loadable kernel module. On Windows, enable PowerShell script block logging: Group Policy → Administrative Templates → Windows PowerShell → Turn on PowerShell Script Block Logging capturing full command text. Configure RDP session shadowing: Enable "Remote Desktop Session Host Configuration" → Connections → RDP-Tcp → Properties → Remote Control for live monitoring. Use process accounting to log all commands: enable psacct: `systemctl enable psacct`, review with lastcomm. Capture file access events: `-w /home -p rwa -k file_access`. Implement DPI for web sessions: deploy SSL intercept proxy (Squid, Blue Coat) capturing HTTPS session content. Store recordings with encryption (AU-9.3). Document user notification requirements (privacy laws). Test: replay recorded session, verify completeness. Integrates with AU-14 (session audit), AU-14.3 (remote viewing), AC-17 (remote access).""",

    "au-14.3": """Prohibit remote viewing or listening except for authorized monitoring. Implement technical controls preventing unauthorized screen sharing, audio capture, and remote control. On RHEL 8/9, disable VNC server by default: `systemctl disable vncserver@.service`, enable only for authorized remote support sessions. Configure X11 forwarding restrictions in /etc/ssh/sshd_config: `X11Forwarding no`, `AllowTcpForwarding no` for standard users. Use PAM to enforce remote access policies: configure /etc/security/access.conf with `-:ALL EXCEPT wheel:ALL` restricting remote login to wheel group. Deploy network access control (NAC) requiring pre-authorization for remote desktop connections. On Windows, disable Remote Desktop by default: Group Policy → Computer Configuration → Administrative Templates → Windows Components → Remote Desktop Services → Deny logons to Remote Desktop Session Host. Implement just-in-time (JIT) privileged access: require approval workflow before enabling RDP, auto-disable after session. Use firewall rules blocking VNC ports (5900-5999), RDP port (3389) except from jump hosts. Deploy endpoint detection and response (EDR) detecting unauthorized remote access tools (TeamViewer, AnyDesk): CrowdStrike, SentinelOne. Audit remote viewing attempts: `-w /usr/bin/vncserver -p x -k remote_viewing`, Windows Event ID 4624 (logon type 10 = Remote Interactive). Create authorized remote access roster: quarterly review of who can remote in, from where, to which systems. Test controls: attempt unauthorized VNC connection, verify block and alert. Integrates with AC-17 (remote access), AC-3 (access enforcement), AU-14.2 (session content capture).""",

    "au-15": """Provide alternate audit logging capability to off-load audit logs to external systems. On RHEL 8/9, configure rsyslog for real-time log forwarding to SIEM: edit /etc/rsyslog.conf with `*.* @@siem.example.com:514` (TCP) or `*.* @siem.example.com:514` (UDP). Deploy audisp-remote plugin for direct auditd forwarding: configure /etc/audit/plugins.d/au-remote.conf with `remote_server = siem.example.com`, `port = 60`, `transport = tcp`. Use TLS encryption for secure forwarding: rsyslog with `$ActionSendStreamDriverMode 1`, `$ActionSendStreamDriverAuthMode x509/name`. Implement message queuing for reliability: configure rsyslog with disk-assisted queue: `$ActionQueueType LinkedList`, `$ActionQueueFileName fwdRule1`, `$ActionResumeRetryCount -1`. For cloud environments, forward logs to CloudWatch (AWS), Azure Monitor, or GCP Cloud Logging using native agents. Deploy Filebeat with output to Elasticsearch, Logstash, or Kafka: edit /etc/filebeat/filebeat.yml with multiple outputs for redundancy. Configure load balancing across multiple SIEM receivers: rsyslog with omrelp module supports failover. On Windows, configure Windows Event Forwarding (WEF): Group Policy → Computer Configuration → Administrative Templates → Windows Components → Event Forwarding. Monitor forwarding health: `journalctl -u rsyslog -f` for errors. Implement local buffering during network outages: rsyslog queue with 1GB capacity. Test failover: disconnect primary SIEM, verify switchover to secondary within 60 seconds. Integrates with AU-4.1 (alternate storage), AU-9.2 (separate systems), SI-4 (monitoring).""",

    "au-16.1": """Associate organization-defined information with audit records for context enrichment. On RHEL 8/9, implement custom audit rule keys with meaningful identifiers: `-w /var/www/html -p wa -k webroot_changes`. Use audisp plugins to inject custom fields into audit stream: create Python plugin reading from /proc, adding process owner department from LDAP. Configure Logstash to enrich audit logs with organizational context: add filters querying asset management database for hostname, cost center, data classification. Example: `filter { elasticsearch { hosts => ["cmdb:9200"] query => "hostname:%{host}" fields => { "business_unit" => "bu" "data_classification" => "classification" } } }`. Deploy osquery with custom tables: create extension querying HR database for user department, manager, location based on username. Use Wazuh decoders to extract and add context: create /var/ossec/etc/decoders/custom_decoder.xml parsing audit events and adding severity levels. Implement tagging in SIEM: Splunk field extractions, Elastic ingest pipelines adding labels like environment (prod/dev), criticality (tier-1/tier-2), compliance scope (PCI/HIPAA). For cloud assets, inject metadata from cloud APIs: AWS tags, Azure resource groups, GCP labels. Document data dictionary: what contextual information exists, where sourced, update frequency. Verify enrichment: query SIEM for `classification:SECRET AND event_type:file_access`. Integrates with AU-3.1 (additional content), CM-8 (system inventory), RA-2 (security categorization).""",

    "au-16.2": """Share audit information and analysis results with authorized organizations. Implement secure information sharing platforms for multi-party audit correlation. On RHEL 8/9, deploy STIX/TAXII server sharing threat indicators: install MISP (Malware Information Sharing Platform), configure taxonomies for audit event classification. Use secure file transfer for audit log sharing: configure SFTP with key-based authentication, create dedicated sharing user with read-only access to anonymized logs. Implement federated SIEM architectures: deploy Elasticsearch cross-cluster search allowing partner organizations to query your audit indices with RBAC restrictions. For critical infrastructure sectors (ISAC participation), use standardized sharing formats: STIX 2.1 for indicators, IODEF for incident data. Configure automated feed sharing: rsyslog forwarding sanitized logs to sector-specific analysis centers. Deploy trust frameworks: SAML federation or OAuth for inter-organizational authentication. Sanitize shared audit logs: remove PII, internal IP addresses, sensitive paths using Logstash filters or Python scripts. Create information sharing agreements (ISA) documenting: what data shared, with whom, for what purpose, retention period. Use encryption for data in transit: TLS 1.3, S/MIME for email attachments. Implement access logging for shared audit data: track which partner accessed what information when. For government environments, use TLP (Traffic Light Protocol) markings: TLP:RED (internal only), TLP:AMBER (limited sharing), TLP:GREEN (community). Verify sharing: confirm partner received and ingested shared audit feed. Integrates with IR-4 (incident handling), PM-16 (threat awareness program), SI-5 (security alerts).""",

    "au-16.3": """Leverage audit information and analysis to support the discovery of indicators of compromise and develop actionable threat intelligence. Deploy threat hunting platforms correlating audit data with known attack patterns. On RHEL 8/9, use MITRE ATT&CK framework mapping audit events to tactics/techniques: create Wazuh ruleset detecting T1078 (Valid Accounts abuse) from unusual sudo patterns. Configure SIEM for IOC matching: Splunk with threat intelligence framework, Elastic with indicator match rules comparing audit events against threat feeds (AlienVault OTX, Talos Intelligence, MISP). Use machine learning for anomaly detection: Elastic SIEM ML jobs detecting unusual process execution, login patterns, file access. Deploy osquery for endpoint threat hunting: create hunt queries correlating audit events with process trees, network connections, file hashes. Implement behavioral analytics: UEBA platforms (Exabeam, Securonix) establishing user baselines and detecting deviations in audit data. Create custom correlation rules for attack chains: detect reconnaissance (nmap scans) → initial access (SSH brute force) → privilege escalation (sudo) → lateral movement (SSH to internal hosts). Use graph databases (Neo4j) to visualize attack paths from audit data: nodes=users/hosts/files, edges=access relationships. Develop threat intelligence from incident analysis: extract TTPs from compromises, create new audit rules detecting similar activities. Share indicators with community (AU-16.2). Implement continuous monitoring dashboards: Grafana with panels showing IOC hit rates, alert trends, threat actor activity. Test effectiveness: conduct purple team exercises, verify audit data captures adversary techniques. Integrates with SI-4 (monitoring), IR-4 (incident handling), RA-5 (vulnerability scanning).""",
}

def enhance_au_controls():
    """Add comprehensive guidance to remaining AU controls."""
    au_file = Path(__file__).parent / 'AU.json'

    # Load AU.json
    with open(au_file, 'r', encoding='utf-8') as f:
        au_data = json.load(f)

    enhanced_count = 0
    for control in au_data:
        control_id = control.get('control_id', '').lower()

        # Check if this control needs enhancement
        if control_id in ENHANCEMENTS:
            current_guidance = control.get('ai_guidance', '')

            # Only enhance if current guidance is insufficient (<800 chars)
            if len(current_guidance) < 800:
                control['ai_guidance'] = ENHANCEMENTS[control_id]
                enhanced_count += 1
                print(f"Enhanced {control_id}: {len(ENHANCEMENTS[control_id])} chars")

    # Write back to AU.json
    with open(au_file, 'w', encoding='utf-8') as f:
        json.dump(au_data, f, indent=2, ensure_ascii=False)

    print(f"\n{'='*70}")
    print(f"Enhancement Complete: {enhanced_count} controls updated")
    print(f"{'='*70}")

    # Verify final state
    technical_controls = [c for c in au_data if c.get('is_technical')]
    well_documented = [c for c in technical_controls if len(c.get('ai_guidance', '')) > 800]

    print(f"\nFinal Statistics:")
    print(f"  Technical controls: {len(technical_controls)}")
    print(f"  With >800 char guidance: {len(well_documented)}")
    print(f"  Coverage: {len(well_documented)*100//len(technical_controls)}%")

if __name__ == '__main__':
    enhance_au_controls()
